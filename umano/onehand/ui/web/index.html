<!DOCTYPE html>
<html lang="en">
<head>
    <title>onehand websocket demo</title>
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style type="text/css">
        body {
            font-family: "Courier New", sans-serif;
            text-align: center;
            height: 800px;
            touch-action: none; /* disable pitch zoom*/
            overflow-y: hidden;
            background-color: black;
            cursor:none;
        }

        .bg {
            background: url("/img/bg.png") center black;
            background-size: cover;
            opacity: 0.1;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

        }

        .state {
            display: flex;
            justify-content: center;
            float: left;
            font-size: 2em;
            color: white;
            position: absolute;
            top: 90%;
        }

        .touch_area {
            min-height: 800px;
            width: 90%;
            border: 2px solid transparent;
            margin: auto;

            -webkit-transition: 3s ease;
            -moz-transition: 3s ease;
            -o-transition: 3s ease;
            background-color: black;
        }
        .touch_area_inside {
            padding: 10%;
            background-color: black;
            display: block;
        }

        .unselectable {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }


    </style>
</head>
<body>
<div class="state unselectable">
    <span class="state_text">?</span>
</div>
    <div class="touch_area">
    </div>
    <div id="particles-js"></div>

    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <script src="js/particles.js"></script>
</body>
<script type="text/javascript">
    jQuery(function ($) {

        particlesJS.load('particles-js', 'assets/particles.json', function () {
            console.log('callback - particles.js config loaded');
        });

        $("body").on("contextmenu", function (e) {
            return false;  //disable right click
        });

        document.addEventListener("touchmove", function (e) {
            return false; // disable pitch zoom
        }, {passive: false});

        var touch_bg = "rgb(15, 15, 15)", hand_on = false;

        var touch_area = document.querySelector('.touch_area'),
            state_text = document.querySelector('.state_text'),
            websocket = new WebSocket("ws://127.0.0.1:6789/"),
            // websocket = new WebSocket("ws://192.168.1.164:6789/"),
            touches = 0;

        function update_touches(event){
            try{
                touches = event.touches.length;
            }catch (e) {
                touches = 0;
            }
        }

        function touch_start(event) {
            websocket.send(JSON.stringify({action: 'touch_start'}));
            $(touch_area).css("background-color", touch_bg);
            update_touches(event);

        }

        function touch_end(event) {
            update_touches(event);
            if (touches === 0){
             websocket.send(JSON.stringify({action: 'touch_end'}));
             $(touch_area).css("background-color", "#000000");
            }
        }

        $(touch_area)
            .on(
                "touchstart", touch_start
            )
            .on(
                "touchend", touch_end
            )
            .on("mousedown", touch_start)
            //.on("mouseup", touch_end)
            //.on("click", function(){console.log("click")})
            .on(
                "transitionend",
                function () {
                    var bg = $(touch_area).css("background-color");
                    console.log("transition end; touches " + touches + "bg " + bg);
                    hand_on = bg === touch_bg;
                    send_hand_state();

                }
            )
        ;

        function send_hand_state() {
            if (hand_on) {
                websocket.send(JSON.stringify({action: 'hand_on'}));
            } else {
                websocket.send(JSON.stringify({action: 'hand_off'}));
            }
            //console.log(hand_on);
        }

        setInterval(send_hand_state, 1000);


        websocket.onmessage = function (event) {
            var data = JSON.parse(event.data);
            console.log(data);
            switch (data.type) {
                case 'state':
                    state_text.textContent = data.value;
                    break;
                default:
                    console.error(
                        "unsupported event", data);
            }
        }
    })
    ;
</script>
</html>